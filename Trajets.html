<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trajets Disponibles - Covoiturage</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #87CEEB 0%, #ffffff 100%);
            min-height: 100vh;
        }

        .header {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
            cursor: pointer;
        }

        .nav-menu {
            display: flex;
            gap: 2rem;
            list-style: none;
            flex: 1;
            justify-content: center;
        }

        .nav-menu a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
            transition: color 0.3s;
        }

        .nav-menu a:hover {
            color: #667eea;
        }

        .auth-buttons {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .panier-icon {
            position: relative;
            cursor: pointer;
            padding: 0.5rem;
            font-size: 1.2rem;
            color: #333;
            transition: color 0.3s;
        }

        .panier-icon:hover {
            color: #667eea;
        }

        .panier-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 20px;
        }

        .page-header {
            text-align: center;
            color: white;
            margin-bottom: 1.5rem;
        }

        .page-header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .page-header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .filters-card {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .filters-header h3 {
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .toggle-filters {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filters-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .filters-content.hidden {
            display: none;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            color: #333;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .filter-group input,
        .filter-group select {
            padding: 0.6rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: border 0.3s;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .filter-actions {
            grid-column: 1 / -1;
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1rem;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            color: white;
        }

        .results-count {
            font-size: 1.1rem;
        }

        .sort-select {
            padding: 0.6rem 1rem;
            border: 2px solid white;
            border-radius: 8px;
            background: rgba(255,255,255,0.2);
            color: white;
            font-weight: 500;
            cursor: pointer;
        }

        .sort-select option {
            color: #333;
        }

        .trajets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 2rem;
        }

        .trajet-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: all 0.3s;
            position: relative;
        }

        .trajet-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .trajet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }

        .badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .conducteur-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .conducteur-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .trajet-route {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .location {
            font-weight: bold;
            color: #333;
            font-size: 1.1rem;
        }

        .arrow {
            color: #667eea;
            font-size: 1.5rem;
        }

        .trajet-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin: 1rem 0;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #666;
            font-size: 0.95rem;
        }

        .icon {
            font-size: 1.1rem;
        }

        .trajet-description {
            background: #f8f9fa;
            padding: 0.8rem;
            border-radius: 8px;
            color: #666;
            font-size: 0.9rem;
            margin: 1rem 0;
            line-height: 1.5;
        }

        .trajet-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid #f0f0f0;
        }

        .price {
            font-size: 1.8rem;
            font-weight: bold;
            color: #667eea;
        }

        .price-label {
            font-size: 0.85rem;
            color: #999;
        }

        .btn {
            padding: 0.6rem 1.5rem;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-secondary:hover {
            background: #f8f9fa;
        }

        .btn-small {
            padding: 0.5rem 1.2rem;
            font-size: 0.9rem;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .no-results {
            grid-column: 1 / -1;
            text-align: center;
            padding: 3rem;
            background: white;
            border-radius: 15px;
        }

        .no-results h3 {
            color: #667eea;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .no-results p {
            color: #666;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
        }

        @media (max-width: 768px) {
            .page-header h1 {
                font-size: 2rem;
            }

            .filters-content {
                grid-template-columns: 1fr;
            }

            .trajets-grid {
                grid-template-columns: 1fr;
            }

            .nav-menu {
                display: none;
            }

            .results-header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
   <!-- Ajoute ceci dans ton <head> -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<!-- ‚úÖ HEADER FINAL -->
<header class="header">
    <div class="nav-container">
        <!-- Logo cliquable -->
        <div class="logo" onclick="window.location.href='index.html'">üöó CovoitPlus</div>

        <!-- Navigation -->
        <nav>
            <ul class="nav-menu">
                <li><a href="/exsepareoffre/index_one.html">Accueil</a></li>
                <li><a href="/exsepareoffre/Trajets.html">Trajets</a></li>
                <li><a href="/exsepareoffre/publier.html">Publier un trajet</a></li>
                <li><a href="/exsepareoffre/mesTrajets.html">Mes trajets</a></li>
                <li id="adminMenuItem" style="display:none;"><a href="/exsepareoffre/admin_dashboard.html">Admin</a></li>
            </ul>
        </nav>

        <!-- Authentification et Panier -->
        <div class="auth-buttons">
            <div class="panier-icon" onclick="showPanier()">
                <i class="fa-solid fa-cart-shopping"></i>
                <span class="panier-count" id="panierCount">0</span>
            </div>
            <button class="btn btn-secondary" onclick="showModal('login')">Connexion</button>
            <button class="btn btn-primary" onclick="showModal('register')">Inscription</button>
        </div>
    </div>
</header>

<script>
        // Met √† jour le lien actif du menu selon la page courante
        document.addEventListener('DOMContentLoaded', function() {
            const path = window.location.pathname.split('/').pop();
            document.querySelectorAll('.nav-menu a').forEach(link => {
                if (link.getAttribute('href') === path) {
                    link.classList.add('active');
                }
            });
        });
        // Afficher le lien Admin si connect√© en admin (v√©rification session via AJAX)
        document.addEventListener('DOMContentLoaded', function() {
            fetch('is_admin.php')
                .then(r => r.json())
                .then(data => {
                    if (data.is_admin) {
                        document.getElementById('adminMenuItem').style.display = '';
                    }
                });
        });
    </script>


    <!-- Page Content -->
    <div class="container">
        <div class="page-header">
            <h1>Trajets Disponibles</h1>
            <p>Trouvez le covoiturage parfait pour votre voyage</p>
        </div>

        <!-- Filtres -->
        <div class="filters-card">
            <div class="filters-header">
                <h3>üîç Filtres de recherche</h3>
                <button class="toggle-filters" onclick="toggleFilters()">
                    <span id="toggleText">Masquer</span>
                    <span id="toggleIcon">‚ñº</span>
                </button>
            </div>
            <div class="filters-content" id="filtersContent">
                <div class="filter-group">
                    <label>D√©part</label>
                    <input type="text" id="filterDepart" placeholder="Ville de d√©part">
                </div>
                <div class="filter-group">
                    <label>Arriv√©e</label>
                    <input type="text" id="filterArrivee" placeholder="Ville d'arriv√©e">
                </div>
                <div class="filter-group">
                    <label>Date</label>
                    <input type="date" id="filterDate">
                </div>
                <div class="filter-group">
                    <label>Places minimum</label>
                    <select id="filterPlaces">
                        <option value="">Toutes</option>
                        <option value="1">1+</option>
                        <option value="2">2+</option>
                        <option value="3">3+</option>
                        <option value="4">4+</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Prix maximum</label>
                    <input type="number" id="filterPrix" placeholder="Prix max (DT)">
                </div>
                <div class="filter-actions">
                    <button class="btn btn-secondary btn-small" onclick="resetFilters()">R√©initialiser</button>
                    <button class="btn btn-primary btn-small" onclick="applyFilters()">Appliquer</button>
                </div>
            </div>
        </div>

        <!-- R√©sultats -->
        <div class="results-header">
            <div class="results-count" id="resultsCount">
                <strong>0</strong> trajet(s) trouv√©(s)
            </div>
            <select class="sort-select" id="sortSelect" onchange="sortTrajets()">
                <option value="date-asc">Date (plus proche)</option>
                <option value="date-desc">Date (plus lointaine)</option>
                <option value="prix-asc">Prix (croissant)</option>
                <option value="prix-desc">Prix (d√©croissant)</option>
                <option value="places-desc">Places (plus ‚Üí  moins)</option>
            </select>
        </div>

        <div class="trajets-grid" id="trajetsGrid">
            <!-- Les trajets seront g√©n√©r√©s par JavaScript -->
        </div>
    </div>

    <!-- Modal Panier -->
    <div class="modal" id="panierModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Mon Panier</h2>
                <button class="close-modal" id="closePanierBtn">&times;</button>
            </div>
            <div id="panierContent"></div>
        </div>
    </div>

    <script>
        // Donn√©es des trajets (charg√©es depuis la base de donn√©es)
        let allTrajets = [];
        let filteredTrajets = [];
        let panier = [];

        // Fonction pour charger les trajets depuis la base de donn√©es
        async function chargerTrajetsActifs() {
            try {
                const response = await fetch('rechercher_trajets.php');
                const data = await response.json();
                
                if (data.success && data.trajets) {
                    // Transformer les donn√©es pour correspondre au format attendu
                    allTrajets = data.trajets.map(trajet => ({
                        id: trajet.id,
                        depart: trajet.lieu_depart,
                        arrivee: trajet.lieu_arrivee,
                        date: trajet.date_trajet,
                        heure: trajet.heure_trajet,
                        places: parseInt(trajet.places_disponibles),
                        prix: parseFloat(trajet.prix),
                        conducteur: trajet.conducteur_nom,
                        description: trajet.description || 'Pas de description',
                        vehicule: trajet.vehicule || ''
                    }));
                    
                    filteredTrajets = [...allTrajets];
                    displayTrajets();
                } else {
                    console.error('Erreur lors du chargement des trajets:', data.message);
                    allTrajets = [];
                    filteredTrajets = [];
                    displayTrajets();
                }
            } catch (error) {
                console.error('Erreur lors du chargement des trajets:', error);
                allTrajets = [];
                filteredTrajets = [];
                displayTrajets();
            }
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            chargerTrajetsActifs(); // Charger les trajets depuis la base de donn√©es
            updatePanierCount();
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('filterDate').setAttribute('min', today);
            
            // Bouton fermer panier - Utiliser d√©l√©gation d'√©v√©nements sur document
            document.addEventListener('click', function(e) {
                if (e.target && e.target.id === 'closePanierBtn') {
                    console.log('üéØ CLIC sur bouton fermeture via d√©l√©gation !');
                    closePanierModal();
                }
            });
            
            console.log('‚úÖ D√©l√©gation √©v√©nement configur√©e pour closePanierBtn');
        });

        // Afficher les trajets
        function displayTrajets() {
            const grid = document.getElementById('trajetsGrid');
            const resultsCount = document.getElementById('resultsCount');
            
            resultsCount.innerHTML = `<strong>${filteredTrajets.length}</strong> trajet(s) trouv√©(s)`;

            if (filteredTrajets.length === 0) {
                grid.innerHTML = `
                    <div class="no-results">
                        <h3>üòï Aucun trajet trouv√©</h3>
                        <p>Essayez de modifier vos crit√®res de recherche</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = '';
            filteredTrajets.forEach(trajet => {
                const badge = trajet.places > 2 ? 'badge-success' : trajet.places > 0 ? 'badge-warning' : 'badge-danger';
                const badgeText = trajet.places > 2 ? 'Disponible' : trajet.places > 0 ? 'Places limit√©es' : 'Complet';
                const initiales = trajet.conducteur.split(' ').map(n => n[0]).join('');

                const card = `
                    <div class="trajet-card">
                        <div class="trajet-header">
                            <span class="badge ${badge}">${badgeText}</span>
                            <div class="conducteur-info">
                                <div class="conducteur-avatar">${initiales}</div>
                                <span style="font-size: 0.9rem; color: #666;">${trajet.conducteur}</span>
                            </div>
                        </div>
                        <div class="trajet-route">
                            <span class="location">${trajet.depart}</span>
                            <span class="arrow">‚Üí</span>
                            <span class="location">${trajet.arrivee}</span>
                        </div>
                        <div class="trajet-details">
                            <div class="detail-item">
                                <span class="icon">üìÖ</span>
                                <span>${formatDate(trajet.date)}</span>
                            </div>
                            <div class="detail-item">
                                <span class="icon">üïê</span>
                                <span>${trajet.heure}</span>
                            </div>
                            <div class="detail-item">
                                <span class="icon">üë•</span>
                                <span>${trajet.places} place(s)</span>
                            </div>
                            <div class="detail-item">
                                <span class="icon">üí∞</span>
                                <span>${trajet.prix} DT / pers</span>
                            </div>
                        </div>
                        ${trajet.description ? `<div class="trajet-description">${trajet.description}</div>` : ''}
                        <div class="trajet-footer">
                            <div>
                                <div class="price">${trajet.prix} DT</div>
                                <div class="price-label">par personne</div>
                            </div>
                            <button class="btn btn-primary btn-small btn-reserver" data-trajet-id="${trajet.id}" ${trajet.places === 0 ? 'disabled' : ''}>
                                ${trajet.places > 0 ? 'üõí R√©server' : 'Complet'}
                            </button>
                        </div>
                    </div>
                `;
                grid.innerHTML += card;
            });

            // Attacher les √©v√©nements click apr√®s avoir ins√©r√© le HTML
            document.querySelectorAll('.btn-reserver').forEach(btn => {
                btn.addEventListener('click', function() {
                    const trajetId = this.getAttribute('data-trajet-id');
                    ajouterAuPanier(trajetId);
                });
            });
        }

        // Formater la date
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const options = { day: 'numeric', month: 'short', year: 'numeric' };
            return date.toLocaleDateString('fr-FR', options);
        }

        // Toggle filtres
        function toggleFilters() {
            const content = document.getElementById('filtersContent');
            const text = document.getElementById('toggleText');
            const icon = document.getElementById('toggleIcon');
            
            content.classList.toggle('hidden');
            if (content.classList.contains('hidden')) {
                text.textContent = 'Afficher';
                icon.textContent = '‚ñ∂';
            } else {
                text.textContent = 'Masquer';
                icon.textContent = '‚ñº';
            }
        }

        // Appliquer les filtres
        function applyFilters() {
            const depart = document.getElementById('filterDepart').value.toLowerCase();
            const arrivee = document.getElementById('filterArrivee').value.toLowerCase();
            const date = document.getElementById('filterDate').value;
            const places = document.getElementById('filterPlaces').value;
            const prix = document.getElementById('filterPrix').value;

            filteredTrajets = allTrajets.filter(trajet => {
                const matchDepart = !depart || trajet.depart.toLowerCase().includes(depart);
                const matchArrivee = !arrivee || trajet.arrivee.toLowerCase().includes(arrivee);
                const matchDate = !date || trajet.date === date;
                const matchPlaces = !places || trajet.places >= parseInt(places);
                const matchPrix = !prix || trajet.prix <= parseFloat(prix);

                return matchDepart && matchArrivee && matchDate && matchPlaces && matchPrix;
            });

            displayTrajets();
        }

        // R√©initialiser les filtres
        function resetFilters() {
            document.getElementById('filterDepart').value = '';
            document.getElementById('filterArrivee').value = '';
            document.getElementById('filterDate').value = '';
            document.getElementById('filterPlaces').value = '';
            document.getElementById('filterPrix').value = '';
            
            filteredTrajets = [...allTrajets];
            displayTrajets();
        }

        // Trier les trajets
        function sortTrajets() {
            const sortType = document.getElementById('sortSelect').value;

            switch(sortType) {
                case 'date-asc':
                    filteredTrajets.sort((a, b) => new Date(a.date) - new Date(b.date));
                    break;
                case 'date-desc':
                    filteredTrajets.sort((a, b) => new Date(b.date) - new Date(a.date));
                    break;
                case 'prix-asc':
                    filteredTrajets.sort((a, b) => a.prix - b.prix);
                    break;
                case 'prix-desc':
                    filteredTrajets.sort((a, b) => b.prix - a.prix);
                    break;
                case 'places-desc':
                    filteredTrajets.sort((a, b) => b.places - a.places);
                    break;
            }

            displayTrajets();
        }

        // Ajouter au panier
        function ajouterAuPanier(trajetId) {
            console.log('üîµ Ajout au panier - trajetId:', trajetId, 'type:', typeof trajetId);
            console.log('üîµ allTrajets disponibles:', allTrajets.length, allTrajets.map(t => ({id: t.id, type: typeof t.id})));
            
            const id = parseInt(trajetId);
            const trajet = allTrajets.find(t => parseInt(t.id) === id);
            if (!trajet) {
                console.error('‚ùå Trajet introuvable! ID recherch√©:', id);
                alert('‚ùå Trajet introuvable (ID: ' + id + ')');
                return;
            }
            
            console.log('‚úÖ Trajet trouv√©:', trajet);
            
            if (trajet.places <= 0) {
                alert('‚ùå Plus de places disponibles');
                return;
            }
            
            // Demander le nombre de places
            const nombrePlaces = prompt('Combien de places souhaitez-vous r√©server ?', '1');
            
            if (!nombrePlaces || parseInt(nombrePlaces) <= 0) {
                return;
            }
            
            const places = parseInt(nombrePlaces);
            
            if (places > trajet.places) {
                alert(`‚ùå Seulement ${trajet.places} place(s) disponible(s)`);
                return;
            }
            
            // V√©rifier si le trajet est d√©j√† dans le panier
            const indexExistant = panier.findIndex(item => item.id === trajetId);
            
            if (indexExistant !== -1) {
                panier[indexExistant].places = places;
                panier[indexExistant].prixTotal = trajet.prix * places;
            } else {
                panier.push({
                    id: trajet.id,
                    depart: trajet.depart,
                    arrivee: trajet.arrivee,
                    date: trajet.date,
                    heure: trajet.heure,
                    prix: trajet.prix,
                    places: places,
                    prixTotal: trajet.prix * places
                });
            }
            
            updatePanierCount();
            alert('‚úÖ Trajet ajout√© au panier !\n' + places + ' place(s) pour ' + (trajet.prix * places) + ' DT');
        }

        // Mettre √† jour le compteur du panier
        function updatePanierCount() {
            document.getElementById('panierCount').textContent = panier.length;
        }

        // Afficher le panier
        function showPanier() {
            const modal = document.getElementById('panierModal');
            const content = document.getElementById('panierContent');
            
            if (panier.length === 0) {
                content.innerHTML = '<p style="text-align: center; color: #999; padding: 2rem;">Votre panier est vide</p>';
            } else {
                let total = 0;
                let html = '<div style="display: flex; flex-direction: column; gap: 1rem;">';
                
                panier.forEach((trajet, index) => {
                    total += trajet.prix;
                    html += `
                        <div style="border: 2px solid #f0f0f0; padding: 1rem; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${trajet.depart} ‚Üí ${trajet.arrivee}</strong>
                                    <div style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">
                                        üìÖ ${formatDate(trajet.date)} √† ${trajet.heure}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 1.2rem; font-weight: bold; color: #667eea;">${trajet.prix} DT</div>
                                    <button class="btn btn-secondary btn-small" onclick="retirerDuPanier(${index})" style="margin-top: 0.5rem;">Retirer</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>
                    <div style="margin-top: 2rem; padding-top: 1rem; border-top: 2px solid #f0f0f0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <strong style="font-size: 1.2rem;">Total:</strong>
                            <strong style="font-size: 1.5rem; color: #667eea;">${total} DT</strong>
                        </div>
                        <button class="btn btn-primary" style="width: 100%; padding: 1rem;" onclick="confirmerReservation()">
                            Confirmer la r√©servation
                        </button>
                    </div>
                `;
                
                content.innerHTML = html;
            }
            
            modal.classList.add('active');
        }

        // Retirer du panier
        function retirerDuPanier(index) {
            panier.splice(index, 1);
            updatePanierCount();
            showPanier();
        }

        // Confirmer la r√©servation
        async function confirmerReservation() {
            if (panier.length === 0) {
                alert('‚ùå Votre panier est vide');
                return;
            }

            console.log('üîµ Confirmation des r√©servations:', panier);
            
            let nbReussies = 0;
            let nbEchecs = 0;
            let messagesErreurs = [];

            for (const item of panier) {
                try {
                    const response = await fetch('creer_reservation.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `trajet_id=${item.id}&nombre_places=${item.places}`
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        nbReussies++;
                        console.log('‚úÖ R√©servation r√©ussie:', item);
                    } else {
                        nbEchecs++;
                        messagesErreurs.push(`${item.depart} ‚Üí ${item.arrivee}: ${data.message}`);
                    }
                } catch (error) {
                    nbEchecs++;
                    messagesErreurs.push(`${item.depart} ‚Üí ${item.arrivee}: Erreur technique`);
                    console.error('‚ùå Erreur:', error);
                }
            }

            let message = '';
            if (nbReussies > 0) {
                message += `‚úÖ ${nbReussies} r√©servation(s) confirm√©e(s) !\n`;
            }
            if (nbEchecs > 0) {
                message += `\n‚ùå ${nbEchecs} √©chec(s):\n` + messagesErreurs.join('\n');
            }
            
            alert(message);
            
            panier = [];
            updatePanierCount();
            closeModal();
            chargerTrajetsActifs(); // Recharger les trajets
        }

        // Fermer les modals
        function closeModal() {
            console.log('üî¥ Fermeture du modal...');
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('active');
            });
        }
        
        function closePanierModal() {
            console.log('üî¥ Fermeture du panier...');
            document.getElementById('panierModal').classList.remove('active');
        }

        // Fermer modal en cliquant √† l'ext√©rieur
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                closeModal();
            }
        }
    </script>
</body>
</html>
