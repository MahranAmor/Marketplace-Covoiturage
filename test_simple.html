<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Test Simple R√©servation</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        .trajet { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
        button { padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #5568d3; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üß™ Test Simple - Syst√®me de R√©servation</h1>
    
    <div id="status"></div>
    <div id="trajets"></div>
    <div id="panier-info"></div>

    <script>
        let allTrajets = [];
        let panier = [];

        // Charger les trajets
        function chargerTrajets() {
            document.getElementById('status').innerHTML = '‚è≥ Chargement des trajets...';
            
            fetch('rechercher_trajets.php')
                .then(r => r.json())
                .then(data => {
                    console.log('üì• Donn√©es re√ßues:', data);
                    
                    if (data.success && data.trajets) {
                        allTrajets = data.trajets.map(t => ({
                            id: parseInt(t.id),
                            depart: t.lieu_depart,
                            arrivee: t.lieu_arrivee,
                            prix: parseFloat(t.prix),
                            places: parseInt(t.places_disponibles),
                            conducteur: t.conducteur_nom
                        }));
                        
                        document.getElementById('status').innerHTML = `‚úÖ ${allTrajets.length} trajets charg√©s`;
                        afficherTrajets();
                    } else {
                        document.getElementById('status').innerHTML = '‚ùå Erreur: ' + (data.message || 'Pas de trajets');
                    }
                })
                .catch(err => {
                    document.getElementById('status').innerHTML = '‚ùå Erreur: ' + err.message;
                    console.error(err);
                });
        }

        // Afficher les trajets
        function afficherTrajets() {
            const container = document.getElementById('trajets');
            container.innerHTML = '<h2>Trajets disponibles:</h2>';
            
            allTrajets.forEach(trajet => {
                container.innerHTML += `
                    <div class="trajet">
                        <strong>${trajet.depart} ‚Üí ${trajet.arrivee}</strong><br>
                        Prix: ${trajet.prix} DT | Places: ${trajet.places}<br>
                        Conducteur: ${trajet.conducteur}<br>
                        <button onclick="reserver(${trajet.id})">R√©server</button>
                    </div>
                `;
            });
            
            console.log('üìä allTrajets:', allTrajets);
        }

        // R√©server un trajet
        function reserver(trajetId) {
            console.log('üéØ R√©servation trajet ID:', trajetId, 'type:', typeof trajetId);
            console.log('üéØ allTrajets IDs:', allTrajets.map(t => ({id: t.id, type: typeof t.id})));
            
            const trajet = allTrajets.find(t => parseInt(t.id) === parseInt(trajetId));
            
            if (!trajet) {
                alert('‚ùå Trajet introuvable!\nID recherch√©: ' + trajetId + '\nIDs disponibles: ' + allTrajets.map(t => t.id).join(', '));
                return;
            }
            
            console.log('‚úÖ Trajet trouv√©:', trajet);
            
            const places = prompt('Nombre de places ?', '1');
            if (!places || parseInt(places) <= 0) return;
            
            panier.push({
                id: trajet.id,
                depart: trajet.depart,
                arrivee: trajet.arrivee,
                prix: trajet.prix,
                places: parseInt(places),
                total: trajet.prix * parseInt(places)
            });
            
            afficherPanier();
            alert('‚úÖ Trajet ajout√© au panier!');
        }

        // Afficher le panier
        function afficherPanier() {
            const container = document.getElementById('panier-info');
            if (panier.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            let html = '<h2>üõí Panier (' + panier.length + ' trajets):</h2><pre>';
            panier.forEach(item => {
                html += `${item.depart} ‚Üí ${item.arrivee} | ${item.places} place(s) = ${item.total} DT\n`;
            });
            html += '</pre><button onclick="confirmer()">Confirmer toutes les r√©servations</button>';
            container.innerHTML = html;
        }

        // Confirmer les r√©servations
        async function confirmer() {
            for (const item of panier) {
                const formData = new URLSearchParams();
                formData.append('trajet_id', item.id);
                formData.append('nombre_places', item.places);
                
                const response = await fetch('creer_reservation.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });
                
                const result = await response.json();
                console.log('R√©servation', item.id, ':', result);
                
                if (!result.success) {
                    alert('‚ùå Erreur pour ' + item.depart + ' ‚Üí ' + item.arrivee + ':\n' + result.message);
                }
            }
            
            alert('‚úÖ R√©servations trait√©es!');
            panier = [];
            afficherPanier();
            chargerTrajets();
        }

        // Chargement initial
        window.onload = function() {
            chargerTrajets();
        };
    </script>
</body>
</html>
